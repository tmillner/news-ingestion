<!DOCTYPE html>
<meta charset="utf-8">
<title></title>
<head>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <style>
html {
  height: 100%;
  box-sizing: border-box;
}

*,
*:before,
*:after {
  box-sizing: inherit;
}

body {
  position: relative;
  margin: 0;
  padding-bottom: 6rem;
  min-height: 100%;
  font-family: "Helvetica Neue", Arial, sans-serif;
}

.app {
  margin: 0 auto;
  padding-top: 12%;
  max-width: 640px;
  width: 94%;
}

#footer {
  position: absolute;
  right: 0;
  bottom: 0;
  left: 0;
  padding: 1rem;
  font-size: 12px;
  background-color: #efefef;
  text-align: center;
}

#left-panel {
  position: fixed;
  left: 0;
  top: 0;
  padding: 2rem;
  padding-bottom: 50px;
  height: 100%;
  background-color: #efefef;
  text-align: left;
  z-index: 1;
  overflow: scroll;
}

#top-panel {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 10;
  padding: 2rem;
  height: 10%;
  width:100%;

  text-align: center;
  z-index: 2;
}

.title {
 font-family: 'Vollkorn SC', 'serif';
}

#submit-button {
    padding: 1rem;
    }

    </style>
<link href="https://fonts.googleapis.com/css?family=Vollkorn+SC" rel="stylesheet">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css">

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script src="https://d3js.org/d3.v4.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"
          integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

 <script>
    /** Set up date picker **/
    var options = {

        showButtonPanel: true,
        dateFormat: "yy-mm-dd",
        altFormat: "yy-mm-dd",
        showOn: "button",
        buttonImage: "https://png.icons8.com/?id=5593&size=40",
        buttonImageOnly: true,
        buttonText: "Select date",
        showAnim: "drop",
        autoSize: true

    };

    $( function() {
        $( ".datepicker" ).datepicker(options);
    } );

    /** Default initializations **/
    $( function() {
        $( "#from_datepicker" ).datepicker( "setDate", "-31d" );
        $( "#to_datepicker" ).datepicker( "setDate", "-0d" );
    });

        /** Set up checkbox functionality **/
      $( function() {
        $( "input" ).width("140").checkboxradio({
          icon: false
        });
      } );
    </script>
</head>
<body>

<script> 
  d3.select("body").style("background-color", "#d6f5f5");

  /* breathing colors */
  var colors = ["#f4ffff", "#d6f5f5"];

  var recolor = function() {
    var c = colors.shift();
    colors.push(c);

    d3.select("body")
    .transition()
    .duration(20000)
    .style("background-color", c)
    .each("end", recolor);
  };

  recolor();
</script>

<script type="text/javascript">
    var app = angular.module("app", []);
    app.controller("controller", function($scope, $http) {
        $http.get("/api/search/repo/sources").then(function(response) {
            $scope.sources = response.data;
        });
        $scope.data = "";
        $scope.radio = {
            "option": "ars-technica"
        };

        var request = function() {
            console.log($scope.radio);

            $scope.fromDate = $( "#from_datepicker" ).datepicker("getDate").toISOString().split('.')[0]+"Z";
            $scope.toDate = $( "#to_datepicker" ).datepicker("getDate").toISOString().split('.')[0]+"Z";

            $http.get("/api/search/repo/" + $scope.radio.option + "/" 
                + $scope.fromDate + "/" 
                + $scope.toDate).then(function(response) {
                $scope.data = response.data;
                return $scope.renderD3View($scope.data);
            });
        };

        $scope.$on('$viewContentLoaded', function() {
            request();
        });

        $scope.grabArticlesForSource = function() {
            request();
        }

        $scope.renderD3View = function(data) {
            /* process data into useable format: stores keyword in a map with an array of source data */
  var keywords = {};

  for (var i in data) {
      for (var j in data[i].keywords) {

      var keyword = data[i].keywords[j];
      var dataToPush = { "source": data[i].source, "publishedAt": data[i].publishedAt, "title":data[i].title, "url":data[i].url };

      if (keywords[keyword] == undefined) {
        keywords[keyword] = [dataToPush];
      }
      else {
        keywords[keyword].push(dataToPush);
      }
    }
  }

  var d3Valid = {"children":[]};
  for (var k in keywords) {
        var toAdd = {}
        toAdd["keyword"] = k;
        toAdd["source"] = keywords[k][0]["source"];
        toAdd["data"] = [];
        for (var article in keywords[k]){
            toAdd["data"].push(keywords[k][article]);
        }
    d3Valid["children"].push(toAdd);
  }

     /* rendering */
  var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

  var format = d3.format(",d");

  var color = d3.scaleOrdinal(d3.schemeCategory20c);

  var pack = d3.pack()
      .size([width, height])
      .padding(1.5);

  var root = d3.hierarchy(d3Valid)
    .sum(function(d) { if (d.data != undefined) {return d.data.length; } else { return 0;} })
    .each(function(d) {         
          d.id = d.data.keyword;
          d.package = d.data.source;
          d.class = d.data.keyword;
    });

  var node = svg.selectAll(".node")
  .data(pack(root).leaves())
  .enter().append("g")
    .attr("class", "node")
    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  node.append("circle")
    .attr("id", function(d) { return d.id; })
    .attr("r", function(d) { return d.r; })
    .style("fill", function(d) { return color(d.package); });

  node.append("clipPath")
    .attr("id", function(d) { return "clip-" + d.id; })
  .append("use")
    .attr("xlink:href", function(d) { return "#" + d.id; });

  node.append("text")
    .attr("clip-path", function(d) { return "url(#clip-" + d.id + ")"; })
  .selectAll("tspan")
  .data(function(d) { return d.class.split(/(?=[A-Z][^A-Z])/g); })
  .enter().append("tspan")
    .attr("x", 0)
    .attr("y", function(d, i, nodes) { return 13 + (i - nodes.length / 2 - 0.5) * 10; })
    .text(function(d) { return d; });

  node.append("title")
    .text(function(d) { return d.id + "\n" + format(d.value); });

        }

    });
</script>


<div ng-app="app" ng-controller="controller">

<div id="left-panel">
<fieldset>
    <legend class="title">Sources:</legend><br />
    <div  ng-repeat="source in sources | orderBy: 'name'" >
     <label for='radio-{{ $index }}' >{{ source.name }}</label>
     <input type='radio' name='radio-1' id='radio-{{ $index }}' ng-model='radio.option' value='{{ source.id }}'> <br />
     </div>
  </fieldset>
</div>

<div id="top-panel">
    <h1 class="title">News Reader</h1>

    <input type="text" id="from_datepicker" class="datepicker">
    <input type="text" id="to_datepicker" class="datepicker">
    <span> <a><img src="https://png.icons8.com/?id=9978&size=50" style="cursor:pointer" ng-click="grabArticlesForSource()"/></a> </span>
 
</div>

<div class="app">
    <svg width="700" height="700" font-family="sans-serif" font-size="13" text-anchor="middle"></svg>
</div>
    <div id="footer">
        Powered by <a href="https://newsapi.org/">News API</a> Â©
    </div>

</div>
</body>
</html>